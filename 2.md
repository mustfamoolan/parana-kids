# توثيق API للمستخدمين - تطبيق الموبايل

## Base URL
```
https://your-domain.com/api
```

---

## 1. تسجيل دخول المدير/المجهز

**Endpoint:** `POST /api/admin/login`

**الوصف:** تسجيل دخول للمدير أو المجهز أو المورد

**Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "login_field": "phone_or_code",
  "password": "password123"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "تم تسجيل الدخول بنجاح",
  "token": "64-character-token-string",
  "expires_at": "2024-12-31T23:59:59+00:00",
  "user": {
    "id": 1,
    "name": "أحمد محمد",
    "email": "ahmed@example.com",
    "phone": "0123456789",
    "code": "ADMIN001",
    "role": "admin",
    "page_name": null,
    "profile_image": "path/to/image.jpg",
    "profile_image_url": "https://domain.com/storage/path/to/image.jpg",
    "private_warehouse_id": null,
    "telegram_chat_id": null,
    "warehouses": [],
    "private_warehouse": null,
    "created_at": "2024-01-01T00:00:00+00:00",
    "updated_at": "2024-01-01T00:00:00+00:00"
  }
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "بيانات الدخول غير صحيحة."
}
```

---

## 2. تسجيل دخول المندوب

**Endpoint:** `POST /api/delegate/login`

**الوصف:** تسجيل دخول للمندوب

**Headers:**
```
Content-Type: application/json
```

**Request Body:**
```json
{
  "code": "DELEGATE001",
  "password": "password123"
}
```

**Response Success (200):**
```json
{
  "success": true,
  "message": "تم تسجيل الدخول بنجاح",
  "token": "64-character-token-string",
  "expires_at": "2024-12-31T23:59:59+00:00",
  "user": {
    "id": 2,
    "name": "محمد علي",
    "email": null,
    "phone": "0987654321",
    "code": "DELEGATE001",
    "role": "delegate",
    "page_name": "صفحة المندوب",
    "profile_image": null,
    "profile_image_url": "https://domain.com/assets/images/profile-1.jpeg",
    "private_warehouse_id": null,
    "telegram_chat_id": null,
    "warehouses": [
      {
        "id": 1,
        "name": "مخزن رئيسي",
        "can_manage": true
      }
    ],
    "private_warehouse": null,
    "created_at": "2024-01-01T00:00:00+00:00",
    "updated_at": "2024-01-01T00:00:00+00:00"
  }
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "بيانات الدخول غير صحيحة."
}
```

---

## 3. معلومات المستخدم الحالي

**Endpoint:** `GET /api/user`

**الوصف:** الحصول على معلومات المستخدم المسجل دخوله

**Headers:**
```
Authorization: Bearer {token}
أو
X-PWA-Token: {token}
```

**Response Success (200):**
```json
{
  "success": true,
  "user": {
    "id": 1,
    "name": "أحمد محمد",
    "email": "ahmed@example.com",
    "phone": "0123456789",
    "code": "ADMIN001",
    "role": "admin",
    "page_name": null,
    "profile_image": "path/to/image.jpg",
    "profile_image_url": "https://domain.com/storage/path/to/image.jpg",
    "private_warehouse_id": null,
    "telegram_chat_id": null,
    "warehouses": [],
    "private_warehouse": null,
    "created_at": "2024-01-01T00:00:00+00:00",
    "updated_at": "2024-01-01T00:00:00+00:00"
  }
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "غير مصرح."
}
```

---

## 4. تحديث بيانات المستخدم

**Endpoint:** `PUT /api/user`

**الوصف:** تحديث بيانات المستخدم الحالي

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body:**
```json
{
  "name": "أحمد محمد الجديد",
  "phone": "0123456789",
  "email": "newemail@example.com",
  "role": "admin",
  "password": "newpassword123"
}
```

**ملاحظات:**
- `password` اختياري (إذا لم يتم إرساله، لن يتم تحديثه)
- `code` مطلوب إذا كان `role` هو `supplier` أو `delegate` أو `private_supplier`
- `page_name` اختياري للمندوب فقط
- `warehouses` (array) مطلوب للمجهز والمندوب
- `private_warehouse_id` مطلوب للمورد

**Response Success (200):**
```json
{
  "success": true,
  "message": "تم تحديث المستخدم بنجاح",
  "user": {
    "id": 1,
    "name": "أحمد محمد الجديد",
    "email": "newemail@example.com",
    "phone": "0123456789",
    "code": "ADMIN001",
    "role": "admin",
    "page_name": null,
    "profile_image": "path/to/image.jpg",
    "profile_image_url": "https://domain.com/storage/path/to/image.jpg",
    "private_warehouse_id": null,
    "telegram_chat_id": null,
    "warehouses": [],
    "private_warehouse": null,
    "created_at": "2024-01-01T00:00:00+00:00",
    "updated_at": "2024-01-15T10:30:00+00:00"
  }
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "غير مصرح."
}
```

---

## 5. جلب المنتجات للمندوب

**Endpoint:** `GET /api/delegate/products`

**الوصف:** جلب جميع المنتجات من المخازن المصرح بها للمندوب

**Headers:**
```
Authorization: Bearer {token}
أو
X-PWA-Token: {token}
```

**Query Parameters (كلها اختيارية):**
- `gender_type` (string): فلتر حسب النوع
  - `boys` - عرض "ولادي" و "ولادي بناتي"
  - `girls` - عرض "بناتي" و "ولادي بناتي"
  - `boys_girls` - عرض "ولادي بناتي" فقط
  - `accessories` - عرض "اكسسوار" فقط
- `has_discount` (string): فلتر المنتجات المخفضة
  - `1` - عرض المنتجات المخفضة فقط
- `search` (string): بحث في القياسات، الكود، النوع، الاسم
- `page` (integer): رقم الصفحة (افتراضي: 1)

**ملاحظات:**
- المندوب يستطيع رؤية المنتجات من المخازن المصرح بها فقط
- المنتجات المحجوبة (`is_hidden = true`) لا تظهر في النتائج
- عدد المنتجات في كل صفحة: 30 منتج

**Response Success (200):**
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "name": "قميص أطفال",
      "code": "PROD001",
      "gender_type": "boys",
      "selling_price": 10000,
      "effective_price": 9000,
      "purchase_price": 8000,
      "description": "وصف المنتج",
      "warehouse": {
        "id": 1,
        "name": "مخزن رئيسي"
      },
      "primary_image": "https://domain.com/storage/products/image.jpg",
      "images": [
        "https://domain.com/storage/products/image1.jpg",
        "https://domain.com/storage/products/image2.jpg"
      ],
      "sizes": [
        {
          "id": 1,
          "size_name": "صغير",
          "quantity": 10,
          "available_quantity": 8,
          "reserved_quantity": 2
        },
        {
          "id": 2,
          "size_name": "متوسط",
          "quantity": 15,
          "available_quantity": 15,
          "reserved_quantity": 0
        }
      ],
      "discount": {
        "has_discount": true,
        "type": "percentage",
        "value": 10,
        "original_price": 10000,
        "discount_price": 9000,
        "discount_amount": 1000,
        "percentage": 10,
        "start_date": "2024-01-01T00:00:00+00:00",
        "end_date": "2024-12-31T23:59:59+00:00"
      },
      "warehouse_promotion": {
        "has_promotion": false
      },
      "created_at": "2024-01-01T00:00:00+00:00",
      "updated_at": "2024-01-15T10:30:00+00:00"
    }
  ],
  "pagination": {
    "current_page": 1,
    "per_page": 30,
    "total": 100,
    "last_page": 4,
    "has_more": true
  }
}
```

**Response Error (403):**
```json
{
  "success": false,
  "message": "غير مصرح. يجب أن تكون مندوباً للوصول إلى هذه البيانات."
}
```

**Response Error (401):**
```json
{
  "success": false,
  "message": "غير مصرح."
}
```

**أمثلة الاستخدام:**

### مثال 1: جلب جميع المنتجات
```
GET /api/delegate/products
Authorization: Bearer {token}
```

### مثال 2: فلتر حسب النوع
```
GET /api/delegate/products?gender_type=boys
Authorization: Bearer {token}
```

### مثال 3: البحث عن منتج
```
GET /api/delegate/products?search=صغير
Authorization: Bearer {token}
```

### مثال 4: فلتر المنتجات المخفضة
```
GET /api/delegate/products?has_discount=1
Authorization: Bearer {token}
```

### مثال 5: فلتر متعدد + pagination
```
GET /api/delegate/products?gender_type=boys&has_discount=1&search=قميص&page=2
Authorization: Bearer {token}
```

**ملاحظات مهمة:**
- `effective_price`: السعر الفعلي بعد تطبيق جميع التخفيضات (منتج + مخزن)
- `available_quantity`: الكمية المتاحة للبيع (الكمية الكلية - المحجوزة)
- `reserved_quantity`: الكمية المحجوزة في السلال النشطة
- `discount`: معلومات تخفيض المنتج الواحد (إن وجد)
- `warehouse_promotion`: معلومات التخفيض العام للمخزن (إن وجد)

---

## 6. إنشاء مستخدم جديد (للمدير فقط)

**Endpoint:** `POST /api/admin/users`

**الوصف:** إنشاء مستخدم جديد (للمدير فقط)

**Headers:**
```
Authorization: Bearer {token}
Content-Type: application/json
```

**Request Body:**
```json
{
  "name": "مستخدم جديد",
  "phone": "0111111111",
  "email": "newuser@example.com",
  "password": "password123",
  "role": "delegate",
  "code": "DELEGATE002",
  "page_name": "صفحة المندوب الجديد",
  "warehouses": [1, 2]
}
```

**ملاحظات:**
- `code` مطلوب إذا كان `role` هو `supplier` أو `delegate` أو `private_supplier`
- `page_name` اختياري للمندوب فقط
- `warehouses` (array) مطلوب للمجهز والمندوب
- `private_warehouse_id` مطلوب للمورد

**Response Success (201):**
```json
{
  "success": true,
  "message": "تم إضافة المستخدم بنجاح",
  "user": {
    "id": 3,
    "name": "مستخدم جديد",
    "email": "newuser@example.com",
    "phone": "0111111111",
    "code": "DELEGATE002",
    "role": "delegate",
    "page_name": "صفحة المندوب الجديد",
    "profile_image": null,
    "profile_image_url": "https://domain.com/assets/images/profile-3.jpeg",
    "private_warehouse_id": null,
    "telegram_chat_id": null,
    "warehouses": [
      {
        "id": 1,
        "name": "مخزن رئيسي",
        "can_manage": false
      },
      {
        "id": 2,
        "name": "مخزن فرعي",
        "can_manage": false
      }
    ],
    "private_warehouse": null,
    "created_at": "2024-01-15T10:30:00+00:00",
    "updated_at": "2024-01-15T10:30:00+00:00"
  }
}
```

**Response Error (403):**
```json
{
  "success": false,
  "message": "غير مصرح. فقط المدير يمكنه إنشاء مستخدمين."
}
```

---

## أنواع المستخدمين (Roles)

- `admin` - المدير
- `supplier` - المجهز
- `delegate` - المندوب
- `private_supplier` - المورد

---

## المصادقة (Authentication)

جميع المسارات المحمية تتطلب إرسال token في أحد الطرق التالية:

### طريقة 1: Authorization Header
```
Authorization: Bearer {token}
```

### طريقة 2: X-PWA-Token Header
```
X-PWA-Token: {token}
```

### طريقة 3: Query Parameter
```
GET /api/user?token={token}
```

---

## أمثلة الاستخدام

### مثال 1: تسجيل دخول في Flutter/Dart
```dart
Future<Map<String, dynamic>> loginAdmin(String loginField, String password) async {
  final response = await http.post(
    Uri.parse('https://your-domain.com/api/admin/login'),
    headers: {'Content-Type': 'application/json'},
    body: jsonEncode({
      'login_field': loginField,
      'password': password,
    }),
  );
  
  return jsonDecode(response.body);
}
```

### مثال 2: الحصول على معلومات المستخدم
```dart
Future<Map<String, dynamic>> getUserInfo(String token) async {
  final response = await http.get(
    Uri.parse('https://your-domain.com/api/user'),
    headers: {
      'Authorization': 'Bearer $token',
      'Content-Type': 'application/json',
    },
  );
  
  return jsonDecode(response.body);
}
```

### مثال 3: تحديث بيانات المستخدم
```dart
Future<Map<String, dynamic>> updateUser(String token, Map<String, dynamic> data) async {
  final response = await http.put(
    Uri.parse('https://your-domain.com/api/user'),
    headers: {
      'Authorization': 'Bearer $token',
      'Content-Type': 'application/json',
    },
    body: jsonEncode(data),
  );
  
  return jsonDecode(response.body);
}
```

### مثال 4: إنشاء مستخدم جديد (للمدير فقط)
```dart
Future<Map<String, dynamic>> createUser(String token, Map<String, dynamic> userData) async {
  final response = await http.post(
    Uri.parse('https://your-domain.com/api/admin/users'),
    headers: {
      'Authorization': 'Bearer $token',
      'Content-Type': 'application/json',
    },
    body: jsonEncode(userData),
  );
  
  return jsonDecode(response.body);
}
```

---

## حفظ Token

بعد تسجيل الدخول، احفظ الـ `token` و `expires_at` في التطبيق (SharedPreferences في Flutter، أو AsyncStorage في React Native) واستخدمه في جميع الطلبات المحمية.

**مثال على حفظ Token في Flutter:**
```dart
// بعد تسجيل الدخول الناجح
await SharedPreferences.getInstance().then((prefs) {
  prefs.setString('token', response['token']);
  prefs.setString('expires_at', response['expires_at']);
});
```

**مثال على حفظ Token في React Native:**
```javascript
// بعد تسجيل الدخول الناجح
import AsyncStorage from '@react-native-async-storage/async-storage';

await AsyncStorage.setItem('token', response.token);
await AsyncStorage.setItem('expires_at', response.expires_at);
```

---

## معالجة الأخطاء

### أخطاء المصادقة (401)
عند الحصول على خطأ 401، يجب إعادة توجيه المستخدم إلى صفحة تسجيل الدخول.

### أخطاء الصلاحيات (403)
عند الحصول على خطأ 403، يعني أن المستخدم ليس لديه صلاحيات للوصول إلى هذا المورد.

### أخطاء التحقق (422)
عند الحصول على خطأ 422، يعني أن البيانات المرسلة غير صحيحة. تحقق من رسالة الخطأ لإصلاح المشكلة.

**مثال على معالجة الأخطاء:**
```dart
try {
  final response = await http.get(
    Uri.parse('https://your-domain.com/api/user'),
    headers: {'Authorization': 'Bearer $token'},
  );
  
  if (response.statusCode == 200) {
    // نجح الطلب
    final data = jsonDecode(response.body);
    return data;
  } else if (response.statusCode == 401) {
    // غير مصرح - إعادة توجيه لتسجيل الدخول
    // Navigate to login screen
    throw Exception('غير مصرح');
  } else {
    // خطأ آخر
    final error = jsonDecode(response.body);
    throw Exception(error['message'] ?? 'حدث خطأ');
  }
} catch (e) {
  // معالجة الخطأ
  print('Error: $e');
  rethrow;
}
```

---

## ملاحظات مهمة

1. **Token الصلاحية:** Token صالح لمدة 30 يوم من تاريخ الإنشاء
2. **تحديث Token:** يمكنك طلب token جديد عند انتهاء الصلاحية
3. **الأمان:** احرص على حفظ Token بشكل آمن في التطبيق
4. **HTTPS:** تأكد من استخدام HTTPS في الإنتاج
5. **Rate Limiting:** قد يكون هناك حد لعدد الطلبات في الدقيقة الواحدة

---

## هيكل بيانات المستخدم

```typescript
interface User {
  id: number;
  name: string;
  email: string | null;
  phone: string;
  code: string | null;
  role: 'admin' | 'supplier' | 'delegate' | 'private_supplier';
  page_name: string | null;
  profile_image: string | null;
  profile_image_url: string;
  private_warehouse_id: number | null;
  telegram_chat_id: string | null;
  warehouses: Warehouse[];
  private_warehouse: PrivateWarehouse | null;
  created_at: string; // ISO 8601 format
  updated_at: string; // ISO 8601 format
}

interface Warehouse {
  id: number;
  name: string;
  can_manage: boolean;
}

interface PrivateWarehouse {
  id: number;
  name: string;
}
```

---

## كودات الحالة (Status Codes)

- `200` - نجح الطلب
- `201` - تم الإنشاء بنجاح
- `401` - غير مصرح (مطلوب token صحيح)
- `403` - ممنوع (ليس لديك صلاحيات)
- `422` - خطأ في التحقق من البيانات
- `500` - خطأ في الخادم

---

## الدعم

للمزيد من المعلومات أو المساعدة، يرجى التواصل مع فريق التطوير.

