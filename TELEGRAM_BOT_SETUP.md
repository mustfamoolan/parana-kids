# إعداد بوت تليجرام لإشعارات الطلبات

## نظرة عامة

تم ربط النظام ببوت تليجرام لإرسال إشعارات الطلبات الجديدة للمجهزين والمديرين حسب صلاحياتهم على المخازن.

## المتطلبات

1. حساب تليجرام
2. بوت تليجرام من @BotFather

## خطوات الإعداد

### 1. إنشاء البوت والحصول على Token

1. افتح تليجرام وابحث عن `@BotFather`
2. أرسل `/newbot` واتبع التعليمات
3. اختر اسماً للبوت (مثال: "Parana Kids Orders Bot")
4. اختر username للبوت (يجب أن ينتهي بـ `bot`)
5. ستحصل على `BOT_TOKEN` - احفظه

### 2. إعداد متغيرات البيئة

أضف المتغيرات التالية إلى ملف `.env`:

```env
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_URL=https://yourdomain.com/telegram/webhook
```

### 3. تشغيل Migration

```bash
php artisan migrate
```

### 4. إعداد Webhook

بعد نشر التطبيق على السيرفر، قم بإعداد webhook:

```bash
# استبدل YOUR_BOT_TOKEN و YOUR_WEBHOOK_URL بالقيم الصحيحة
curl -X POST "https://api.telegram.org/botYOUR_BOT_TOKEN/setWebhook" \
  -d "url=https://yourdomain.com/telegram/webhook"
```

للتحقق من أن webhook تم إعداده بنجاح:

```bash
curl "https://api.telegram.org/botYOUR_BOT_TOKEN/getWebhookInfo"
```

## كيفية الاستخدام

### ربط حساب المستخدم

1. افتح البوت في تليجرام
2. أرسل `/start`
3. أرسل رقم هاتفك المسجل في النظام أو الكود الخاص بك
4. سيتم ربط حسابك تلقائياً

### إلغاء الربط

أرسل `/unlink` للبوت لإلغاء ربط حسابك.

## آلية العمل

1. عند إنشاء طلب جديد من المندوب:
   - يتم تحديد المخازن التي تحتوي على منتجات الطلب
   - يتم تحديد المجهزين والمديرين الذين لديهم صلاحية على هذه المخازن
   - يتم إرسال إشعار تليجرام لكل مجهز مربوط بحسابه

2. الإشعار يحتوي على:
   - رقم الطلب
   - اسم العميل
   - رقم الهاتف
   - العنوان
   - المبلغ الإجمالي
   - الملاحظات (إن وجدت)
   - وقت إنشاء الطلب

## ملاحظات مهمة

- فقط المجهزين (suppliers) والمديرين (admins) يمكنهم ربط حساباتهم
- يجب أن يكون المستخدم مربوطاً بحسابه في تليجرام ليستقبل الإشعارات
- الإشعارات تُرسل فقط للمستخدمين المربوطين

## استكشاف الأخطاء

### البوت لا يستجيب

1. تحقق من أن `TELEGRAM_BOT_TOKEN` صحيح في `.env`
2. تحقق من أن webhook تم إعداده بشكل صحيح
3. راجع ملفات السجلات: `storage/logs/laravel.log`

### الإشعارات لا تصل

1. تأكد من أن المستخدم مربوط بحسابه (أرسل `/start` للبوت)
2. تحقق من أن المستخدم لديه صلاحية على مخازن منتجات الطلب
3. راجع ملفات السجلات للتحقق من أي أخطاء

## الأمان

- يتم التحقق من صحة الطلبات من تليجرام
- ربط المستخدمين يتم عبر رقم الهاتف أو الكود المسجل في النظام
- لا يمكن ربط حساب واحد بحسابين تليجرام مختلفين في نفس الوقت

